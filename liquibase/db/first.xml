<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

    <changeSet id="create_table_tauto_charge_reduction" author="mnikolaev">
        <createTable schemaName="db_case" tableName="tauto_charge_reduction">
            <column name="id" type="bigserial">
                <constraints primaryKey="true"
                             primaryKeyName="pktauto_charge_reduction_id"/>
            </column>
            <column name="tcase_id" type="bigint">
                <constraints foreignKeyName="fktautochargereduction_tcase_id"
                             unique="true"
                             uniqueConstraintName="iutautochargereduction_tcase_id"
                             nullable="false"
                             references="tcase(id)"
                             deleteCascade="true"/>
            </column>
            <column name="is_aun_check" type="boolean">
                <constraints nullable="false"/>
            </column>
            <column name="is_related_service" type="boolean"/>
            <column name="result" type="varchar(4000)"/>
            <column name="start_date" type="date"/>
            <column name="end_date" type="date"/>
        </createTable>
    </changeSet>

    <changeSet id="create_table_tincident" author="mnikolaev">
        <createTable schemaName="db_case" tableName="tincident">
            <column name="id" type="bigserial">
                <constraints primaryKey="true"
                             primaryKeyName="pktincident_id"/>
            </column>
            <column name="tauto_charge_reduction_id" type="bigint">
                <constraints foreignKeyName="fktincident_tauto_charge_reduction_id"
                             references="tauto_charge_reduction(id)"
                             deleteCascade="true"/>
            </column>
            <column name="ext_case_id" type="varchar(50)"/>
            <column name="start_date" type="date"/>
            <column name="end_date" type="date"/>
            <column name="close_code" type="varchar(255)"/>
        </createTable>
    </changeSet>

    <changeSet id="create_enum_case_relate_type" author="mnikolaev">
        <sql>
            CREATE TYPE db_case.case_relate_type AS ENUM ('PARENT_CHILD', 'SUBCASE', 'SIBLING');
        </sql>
        <rollback>
            DROP TYPE db_case.case_relate_type;
        </rollback>
    </changeSet>

    <changeSet id="create_table_tcase_tcase" author="mnikolaev">
        <createTable schemaName="db_case" tableName="tcase_tcase">
            <column name="tcase_id1" type="bigint">
                <constraints primaryKey="true"
                             primaryKeyName="pktcasetcase_tcase_id1tcase_id2"
                             foreignKeyName="fktcasetcase_tcase_id1"
                             references="tcase(id)"
                             deleteCascade="true"
                             nullable="false"/>
            </column>
            <column name="tcase_id2" type="bigint">
                <constraints primaryKey="true"
                             primaryKeyName="pktcasetcase_tcase_id1tcase_id2"
                             foreignKeyName="fktcasetcase_tcase_id2"
                             references="tcase(id)"
                             deleteCascade="true"
                             nullable="false"/>
            </column>
            <column name="relate_type" type="db_case.case_relate_type">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create_enum_relate_object_type" author="mnikolaev">
        <sql>
            CREATE TYPE db_case.relate_object_type AS ENUM ('GLOBAL_PROBLEM', 'ORDER');
        </sql>
        <rollback>
            DROP TYPE db_case.relate_object_type;
        </rollback>
    </changeSet>

    <changeSet id="create_table_trelate_object" author="mnikolaev">
        <createTable schemaName="db_case" tableName="trelate_object">
            <column name="id" type="bigserial">
                <constraints primaryKey="true"
                             primaryKeyName="pktrelateobject_id"/>
            </column>
            <column name="tcase_id" type="bigint">
                <constraints foreignKeyName="fktrelateobject_tcase_id"
                             nullable="false"
                             references="tcase(id)"/>
            </column>
            <column name="object_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="object_type" type="db_case.relate_object_type">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
</databaseChangeLog>
